version 1.0

task IsONclust {
  input {
    String? fast_q
    String? fl_nc
    String? ccs
    String? number_cores_allocated
    String? debugging_prints_status
    String? filters_reads_average
    Boolean? ont
    Boolean? iso_seq
    Boolean? use_old_sorted_file
    Boolean? consensus
    String? abundance_ratio
    String? rc_identity_threshold
    Boolean? medaka
    String? kmer_size_default
    String? window_size_default
    Int? min_shared
    String? mapped_threshold
    String? aligned_threshold
    String? batch_type
    Int? min_fraction
    Int? min_prob_no_hits
    String? out_folder
  }
  command <<<
    isONclust \
      ~{if defined(fast_q) then ("--fastq " +  '"' + fast_q + '"') else ""} \
      ~{if defined(fl_nc) then ("--flnc " +  '"' + fl_nc + '"') else ""} \
      ~{if defined(ccs) then ("--ccs " +  '"' + ccs + '"') else ""} \
      ~{if defined(number_cores_allocated) then ("--t " +  '"' + number_cores_allocated + '"') else ""} \
      ~{if defined(debugging_prints_status) then ("--d " +  '"' + debugging_prints_status + '"') else ""} \
      ~{if defined(filters_reads_average) then ("--q " +  '"' + filters_reads_average + '"') else ""} \
      ~{true="--ont" false="" ont} \
      ~{true="--isoseq" false="" iso_seq} \
      ~{true="--use_old_sorted_file" false="" use_old_sorted_file} \
      ~{true="--consensus" false="" consensus} \
      ~{if defined(abundance_ratio) then ("--abundance_ratio " +  '"' + abundance_ratio + '"') else ""} \
      ~{if defined(rc_identity_threshold) then ("--rc_identity_threshold " +  '"' + rc_identity_threshold + '"') else ""} \
      ~{true="--medaka" false="" medaka} \
      ~{if defined(kmer_size_default) then ("--k " +  '"' + kmer_size_default + '"') else ""} \
      ~{if defined(window_size_default) then ("--w " +  '"' + window_size_default + '"') else ""} \
      ~{if defined(min_shared) then ("--min_shared " +  '"' + min_shared + '"') else ""} \
      ~{if defined(mapped_threshold) then ("--mapped_threshold " +  '"' + mapped_threshold + '"') else ""} \
      ~{if defined(aligned_threshold) then ("--aligned_threshold " +  '"' + aligned_threshold + '"') else ""} \
      ~{if defined(batch_type) then ("--batch_type " +  '"' + batch_type + '"') else ""} \
      ~{if defined(min_fraction) then ("--min_fraction " +  '"' + min_fraction + '"') else ""} \
      ~{if defined(min_prob_no_hits) then ("--min_prob_no_hits " +  '"' + min_prob_no_hits + '"') else ""} \
      ~{if defined(out_folder) then ("--outfolder " +  '"' + out_folder + '"') else ""}
  >>>
  parameter_meta {
    fast_q: "Path to consensus fastq file(s) (default: False)"
    fl_nc: "The flnc reads generated by the isoseq3 algorithm (BAM file) (default: False)"
    ccs: "Path to consensus BAM file(s) (default: False)"
    number_cores_allocated: "Number of cores allocated for clustering (default: 8)"
    debugging_prints_status: "For debugging, prints status of clustering and minimizer database every p reads processed. (default: 10000)"
    filters_reads_average: "Filters reads with average phred quality value under this number (default = 7.0). (default: 7.0)"
    ont: "Clustering of ONT transcript reads. (default: False)"
    iso_seq: "Clustering of PacBio Iso-Seq reads. (default: False)"
    use_old_sorted_file: "Using already existing sorted file if present in specified output directory. (default: False)"
    consensus: "After clustering, (1) run spoa on all clusters, (2) detect reverse complements, (3) run medaka. (default: False)"
    abundance_ratio: "Threshold for --consensus algorithm. Consider only clusters larger than a fraction of number of total reads (default 0.1) (default: 0.1)"
    rc_identity_threshold: "Threshold for --consensus algorithm. Define a reverse complement if identity is over this threshold (default 0.9) (default: 0.9)"
    medaka: "Run final medaka polishing algorithm. (default: False)"
    kmer_size_default: "Kmer size (default: 15)"
    window_size_default: "Window size (default: 50)"
    min_shared: "Minmum number of minimizers shared between read and cluster (default: 5)"
    mapped_threshold: "Minmum mapped fraction of read to be included in cluster. The density of minimizers to classify a region as mapped depends on quality of the read. (default: 0.7)"
    aligned_threshold: "Minmum aligned fraction of read to be included in cluster. Aligned identity depends on the quality of the read. (default: 0.4)"
    batch_type: "In parrallel mode, how to split the reads into chunks \"total_nt\", \"nr_reads\", or \"weighted\" (default: total_nt) (default: total_nt)"
    min_fraction: "Minmum fraction of minimizers shared compared to best hit, in order to continue mapping. (default: 0.8)"
    min_prob_no_hits: "Minimum probability for i consecutive minimizers to be different between read and representative and still considered as mapped region, under assumption that they come from the same transcript (depends on read quality). (default: 0.1)"
    out_folder: "A fasta file with transcripts that are shared between samples and have perfect illumina support. (default: None)"
  }
}