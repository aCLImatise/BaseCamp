version 1.0

task AnviUpdateStructureDatabase {
  input {
    String? contigs_db
    String? structure_db
    File? genes_of_interest
    String? gene_caller_ids
    String? dump_dir
    Boolean? list_modeller_params
    Boolean? rerun_genes
    String? modeller_executable
    String? num_threads
    Int? write_buffer_size_per_thread
  }
  command <<<
    anvi-update-structure-database \
      ~{if defined(contigs_db) then ("--contigs-db " +  '"' + contigs_db + '"') else ""} \
      ~{if defined(structure_db) then ("--structure-db " +  '"' + structure_db + '"') else ""} \
      ~{if defined(genes_of_interest) then ("--genes-of-interest " +  '"' + genes_of_interest + '"') else ""} \
      ~{if defined(gene_caller_ids) then ("--gene-caller-ids " +  '"' + gene_caller_ids + '"') else ""} \
      ~{if defined(dump_dir) then ("--dump-dir " +  '"' + dump_dir + '"') else ""} \
      ~{true="--list-modeller-params" false="" list_modeller_params} \
      ~{true="--rerun-genes" false="" rerun_genes} \
      ~{if defined(modeller_executable) then ("--modeller-executable " +  '"' + modeller_executable + '"') else ""} \
      ~{if defined(num_threads) then ("--num-threads " +  '"' + num_threads + '"') else ""} \
      ~{if defined(write_buffer_size_per_thread) then ("--write-buffer-size-per-thread " +  '"' + write_buffer_size_per_thread + '"') else ""}
  >>>
  parameter_meta {
    contigs_db: "Anvi'o contigs database generated by 'anvi-gen- contigs'"
    structure_db: "Anvi'o structure database."
    genes_of_interest: "A file with anvi'o gene caller IDs. There should be only one column in the file, and each line should correspond to a unique gene caller id (without a column header)."
    gene_caller_ids: "Gene caller ids. Multiple of them can be declared separated by a delimiter (the default is a comma). In anvi-gen-variability-profile, if you declare nothing you will get all genes matching your other filtering criteria. In other programs, you may get everything, nothing, or an error. It really depends on the situation. Fortunately, mistakes are cheap, so it's worth a try."
    dump_dir: "Modeling and annotating structures requires a lot of moving parts, each which have their own outputs. The output of this program is a structure database containing the pertinent results of this computation, however a lot of stuff doesn't make the cut. By providing a directory for this parameter you will get, in addition to the structure database, a directory containing the raw output for everything."
    list_modeller_params: "Since you are updating an existing DB, modeller params are set in place. You can have this program list them by providing this flag"
    rerun_genes: "Supply if you would like to rerun structural modelling for your genes of interest if they are already present in your DB"
    modeller_executable: "The MODELLER program to use. For example, `mod9.19`. Anvi'o will try and find it if not provided."
    num_threads: "Maximum number of threads to use for multithreading whenever possible. Very conservatively, the default is 1. It is a good idea to not exceed the number of CPUs / cores on your system. Plus, please be careful with this option if you are running your commands on a SGE --if you are clusterizing your runs, and asking for multiple threads to use, you may deplete your resources very fast."
    write_buffer_size_per_thread: "How many items should be kept in memory before they are written do the disk. The default is 25 per thread. So a single-threaded job would have a write buffer size of 25, whereas a job with 4 threads would have a write buffer size of 4*25. The larger the buffer size, the less frequent the program will access to the disk, yet the more memory will be consumed since the processed items will be cleared off the memory only after they are written to the disk. The default buffer size will likely work for most cases. Please keep an eye on the memory usage output to make sure the memory use never exceeds the size of the physical memory. If --num-threads is 1, this parameter is ignored because the DB is written to after each gene"
  }
}